<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Solution Pattern: API Versioning :: Solution Patterns from Red Hat</title>
    <link rel="canonical" href="https://redhat-solution-patterns.github.io/solution-patterns/api-versioning/03-demo.html">
    <link rel="prev" href="02-architecture.html">
    <link rel="next" href="04-developer-resources.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Q5V9XB1KMP"></script>
<script>function gtag() { dataLayer.push(arguments) }; window.dataLayer = window.dataLayer || []; gtag('js', new Date()); gtag('config', 'G-Q5V9XB1KMP')</script>
  </head>
  <body class="article">

<header class="header">
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () { 
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('USERID');
      const subdomain = urlParams.get('SUBDOMAIN'); 
      if (userId) {
        showUserId( userId, subdomain);
      }
      else {
        showUserIdForm(subdomain);
      }
    } );


    function showUserId( userId, subdomain) {
      document.getElementById('navbar-form-empty').style.display = "none";
      document.getElementById('navbar-form-filled').style.display = "flex";
      document.getElementById('userIdDisplay').textContent = "User ID : " + userId;
      document.getElementById('subdomainDisplay').textContent = "Subdomain : " + subdomain; 
    }

    function showUserIdForm( subdomain ) {
      document.getElementById('navbar-form-empty').style.display = "flex";
      document.getElementById('navbar-form-filled').style.display = "none";
      document.getElementById('subdomain').value = subdomain; 

    }

    function goWithUserId() {
      elUserIdInput = document.getElementById('userId');
      elSubdomainInput = document.getElementById('subdomain');
      window.location.search = ('&USERID=' + elUserIdInput.value  + '&SUBDOMAIN=' + elSubdomainInput.value);
    }

    function recycle() {
      document.getElementById('userId').value='';
      document.getElementById('subdomain').value='';
      window.location.search = ('');
    }


  </script>
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" style="font-size: 20px; color: white" href="https://redhat-solution-patterns.github.io/solution-patterns">
        <img src="../_/img/logo.png" height="35px" alt="Solution Patterns">&nbsp; Solution Patterns from Red Hat</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Architectures &amp; Patterns</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.redhat.com/architect/portfolio/" target="_blank">Portfolio Architecture&nbsp; </a>
            <a class="navbar-item" href="https://redhat-solution-patterns.github.io/solution-patterns/patterns.html"  target="_blank">Solution Patterns </a>
            <a class="navbar-item" href="https://validatedpatterns.io/" target="_blank">Validated Patterns&nbsp;</a>
            <a class="navbar-item" href="https://catalog.redhat.com/solutions" target="_blank">Ecosystem Solutions&nbsp;</a>
          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" target="_blank" href="https://developers.redhat.com">Red Hat Developers</a>
            <a class="navbar-item" target="_blank" href="https://developers.redhat.com/app-dev-platform">App Dev Platform</a>
            <a class="navbar-item" target="_blank" href="https://www.redhat.com/en/products/application-foundations">Red Hat Application Services</a>
          </div>
        </div>

          <a class="navbar-item" target="_blank" href="https://github.com/redhat-solution-patterns/redhat-solution-patterns.github.io/issues">Feedback</a>
          <a class="navbar-item" target="_blank" href="https://redhat-solution-patterns.github.io/solution-patterns/contributors-guide.html">Contribute</a>

          <div class="navbar-item" >         
              <div id="navbar-form-empty">
                <span >
                  <span>
                    &nbsp;
                    <i style="color: orange;" class="fa fa-exclamation-triangle" aria-hidden="true"></i>
                  </span>
                  Your Workshop Environment
                <form action="javascript:void(0);" onsu>
                  <input size="20" id="userId" type="text" placeholder="USER ID">
                  <input size="20" id="subdomain" type="text" placeholder="Subdomain">
                  <button type="hidden" onclick="goWithUserId();">Set</button>
                </form>
                </span>
              </div>
        
              <div  id="navbar-form-filled" style="display: none;">
                <span>
                <span>
                  Your Workshop Environment
                    <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">
                    <i alt="Clear details" title="Clear details" onclick="recycle();" style="color: green;" class="fa fa-recycle" aria-hidden="true"></i>
                    <br><span  id="userIdDisplay"></span> <span>|</span>
                <span id="subdomainDisplay"></span>
              </div>
          </div>
      </div>
    </div>
  </nav>
</header>

<div class="body">
<div class="nav-container" data-component="api-versioning" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">API Versioning</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">1. Home page</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#use-cases">1.1 Use cases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_the_story_behind_this_solution_pattern">1.2 The story behind this solution pattern</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_the_solution">1.3 The solution</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-architecture.html">2. Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#tech_stack">2.1. Technology stack</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#in_depth">2.2. An in-depth look at the solution&#8217;s architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#more_tech">2.3. More about the technology stack</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-demo.html">3. See the Solution in Action</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_setup_the_solution">3.1. Setup the solution</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_walkthrough_guide">3.2. Walkthrough guide</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-developer-resources.html">4. Developer Resources</a>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text"><a href="https://redhat-solution-patterns.github.io/solution-patterns/patterns.html" target="_blank" rel="noopener">Explore Red Hat Solution Patterns</a></span>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">API Versioning</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">API Versioning</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">API Versioning</a></li>
    <li><a href="03-demo.html">3. See the Solution in Action</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-solution-patterns/solution-pattern-api-versioning/edit/main/documentation/modules/ROOT/pages/03-demo.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Solution Pattern: API Versioning</h1>
<h1 id="_see_the_solution_in_action" class="sect0"><a class="anchor" href="#_see_the_solution_in_action"></a><a class="link" href="#_see_the_solution_in_action">See the Solution in Action</a></h1>
<div class="sect1">
<h2 id="_setup_the_solution"><a class="anchor" href="#_setup_the_solution"></a><a class="link" href="#_setup_the_solution">1. Setup the solution</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To provision the demo you will perform the following steps - each of which are explained in detail in the next sections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gain access to Red Hat OpenShift. This solution pattern has been tested on <a href="https://docs.openshift.com/container-platform/4.15/welcome/index.html" target="_blank" rel="noopener">OpenShift 4.15</a></p>
</li>
<li>
<p>Ensure you have the tools <code>oc</code> and <code>ansible</code> installed in your local environment such as your laptop</p>
</li>
<li>
<p>Access the OpenShift cluster with cluster-admin privileges</p>
</li>
<li>
<p>Log in to OpenShift with <code>cluster-admin</code> role via cli</p>
</li>
<li>
<p>Run the Ansible playbook</p>
</li>
<li>
<p>Run a bunch of scripts to deploy the Solution Pattern in your OpenShift cluster</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_pre_requisites"><a class="anchor" href="#_pre_requisites"></a><a class="link" href="#_pre_requisites">1.1. Pre-requisites</a></h3>
<div class="paragraph">
<p>Here is the list of tools you need in your local environment so that you can use the automated installation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.openshift.com/container-platform/4.15/cli_reference/openshift_cli/getting-started-cli.html" target="_blank" rel="noopener">OpenShift CLI (oc client)</a></p>
</li>
<li>
<p><a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html" target="_blank" rel="noopener">Ansible CLI </a> with <a href="https://docs.ansible.com/ansible/latest/collections/kubernetes/core/k8s_module.html" target="_blank" rel="noopener">Ansible kubernetes.core module</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To check if you have the cli tools, you can open your terminal and use following commands:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">oc version #openshift cli client
ansible --version
ansible-galaxy --version
ansible-galaxy collection list #the list should include kubernetes.core</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you can&#8217;t see <code>kubernetes.core</code> collection listed, you can install it with <code>ansible-galaxy</code>:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">ansible-galaxy collection install kubernetes.core</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installing_the_demo"><a class="anchor" href="#_installing_the_demo"></a><a class="link" href="#_installing_the_demo">1.2. Installing the demo</a></h3>
<div class="ulist">
<ul>
<li>
<p>Login to your OpenShift cluster as cluster-admin (because a number of operators will need to be installed)</p>
</li>
<li>
<p>Click on the username on the top right hand, and then click on <strong>Copy login command</strong>. This will open another tab and you will need to login again</p>
</li>
<li>
<p>Click on <strong>Display token</strong> link, and copy the command under <strong>Log in with this token</strong>. This will look like this</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">oc login --token=&lt;token&gt; --server=&lt;server&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the ansible scripts as follows in an appropriate folder in your local environment</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">git clone https://github.com/rh-soln-pattern-api-versioning/globex-ansible</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Run the following command to setup the fundamental config needed. Ensure that the ansible playbook is deployed without errors</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">ansible-playbook playbook.yml --skip-tags "apim"</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>This is the output you get from the above ansible command:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>PLAY RECAP ****************************************************************************************
localhost         : ok=86  changed=17  unreachable=0  failed=0  skipped=31  rescued=0  ignored=0</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it! You are set to try out this Solution Pattern! ｡◕‿◕｡</p>
</div>
</div>
<div class="sect2">
<h3 id="_personalize_the_instructions"><a class="anchor" href="#_personalize_the_instructions"></a><a class="link" href="#_personalize_the_instructions">1.3. Personalize the instructions</a></h3>
<div class="paragraph">
<p>To personalize the rest of the instructions to your OpenShift environment,</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At the top-right of this page enter</p>
<div class="ulist">
<ul>
<li>
<p><strong>subdomain</strong> to match your OpenShift cluster under the <strong>Your Workshop Environment</strong> section</p>
</li>
</ul>
</div>
</li>
<li>
<p>Press enter or click on the Set button</p>
<div class="imageblock">
<div class="content">
<img src="_images/setup-instructions.png" alt="setup instructions">
</div>
</div>
</li>
<li>
<p>The menubar and the rest of this walkthrough guide will be updated with the username and subdomain as shown below</p>
<div class="imageblock">
<div class="content">
<img src="_images/setup-instructions-complete.png" alt="setup instructions complete">
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The subdomain would look something like this <code>apps.cluster-name.guid.subdomain.myopenshift.com</code></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_walkthrough_guide"><a class="anchor" href="#_walkthrough_guide"></a><a class="link" href="#_walkthrough_guide">2. Workshop Walkthrough guide</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here is an overview of what you will achieve</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/steps.png" alt="steps">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Design, Govern and Mock phases of API lifecycle have been discussed in other <a href="https://redhat-solution-patterns.github.io/solution-pattern-api-first" target="_blank" rel="noopener">solutions patterns</a>; so in this pattern we will skip straight to the implementing API versioning. So, this solution pattern focuses on how 3scale API management and OpenShift can help with API versioning.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_1_overview"><a class="anchor" href="#_step_1_overview"></a><a class="link" href="#_step_1_overview">3. Step 1: Overview</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s walk through an overview of the components that have been setup already</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Launch the <a href="https://console-openshift-console.%SUBDOMAIN%" target="console">OpenShift console</a> and login</p>
</li>
<li>
<p>Navigate to <strong>Topology</strong> from the Developer&#8217;s view of the <code>globex-user1</code> project</p>
<div class="imageblock">
<div class="content">
<img src="_images/globex-user1.png" alt="globex user1" width="70%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The center section under the name <strong>globex-app-user1</strong> contains the components needed for the first version of the application and the api.</p>
<div class="ulist">
<ul>
<li>
<p><code>globex-ui</code> is the retail website</p>
</li>
<li>
<p><code>order-placement</code> is the microservice which implements the OrderPlacement API. This service validates incoming payload against JSON Schema of the OpenAPI spec.</p>
</li>
<li>
<p><code>catalog</code> and <code>inventory</code> components provide the services needed for the retail websites.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The left section <strong>v1-1</strong> is the (future looking) setup for v1-1.</p>
<div class="ulist">
<ul>
<li>
<p>This is at zero pods at the moment because the corresponding API version is not setup yet</p>
</li>
</ul>
</div>
</li>
<li>
<p>The right <strong>v2-0</strong> is the (future looking) setup for v2-0.</p>
<div class="ulist">
<ul>
<li>
<p>This is at zero pods at the moment because the corresponding API version is not setup yet</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_2_enable_version_1_0_0"><a class="anchor" href="#_step_2_enable_version_1_0_0"></a><a class="link" href="#_step_2_enable_version_1_0_0">4. Step 2: Enable Version 1.0.0</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_api_specification_and_governance"><a class="anchor" href="#_api_specification_and_governance"></a><a class="link" href="#_api_specification_and_governance">4.1. API specification and governance</a></h3>
<div class="paragraph">
<p>The version 1.0.0 of this <strong>Globex Order Placement API</strong> has already been created for you. This can be viewed in github <a href="https://raw.githubusercontent.com/rh-soln-pattern-api-versioning/api-spec/main/v1.0/OrderPlacementAPI-V1.0.yaml" target="_blank" rel="noopener">here</a>. You can note how the version is represented in the following snippet</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">openapi: 3.0.2
info:
  title: OrderPlacementAPI V1.0
  version: 1.0.0
  description: 'API Call to place an order with product, address and user details'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_as_a_backend_developer"><a class="anchor" href="#_as_a_backend_developer"></a><a class="link" href="#_as_a_backend_developer">4.2. As a backend developer</a></h3>
<div class="paragraph">
<p><strong>Setup OrderPlacement backend service</strong></p>
</div>
<div class="paragraph">
<p>The backend of OrderPlacement API for the purpose of this demo, acts as a facade to receive the payload, and then posts the Order payload to a <a href="https://webhook.site/" target="_blank" rel="noopener">https://webhook.site/</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In real life, there are a number ways this payload can be handled</p>
</div>
<div class="ulist">
<ul>
<li>
<p>payload maybe be processed asynchronously through a event driven architecture</p>
</li>
<li>
<p>payload maybe stored in a SQL based database or a no-SQL database</p>
</li>
<li>
<p>payload may need to be posted to a number of other downstream systems.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As seen earlier, the OrderPlacement backend service has already been provisioned for you. You will now update the enviornment variables.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <strong>ORDER_PLACEMENT_API</strong> env variable of the OrderPlacement backend service has a placeholder which needs to be replaced.</p>
<div class="imageblock">
<div class="content">
<img src="_images/order-placement-config-before.png" alt="order placement config before">
</div>
</div>
</li>
<li>
<p>Launch <a href="https://webhook.site/" target="_blank" rel="noopener">https://webhook.site/</a>, and copy the the URL displayed as <strong>Your unique URL</strong> by clicking on it</p>
<div class="imageblock">
<div class="content">
<img src="_images/webhook-site-unique-url.png" alt="webhook site unique url">
</div>
</div>
</li>
<li>
<p>From your command prompt, set an environment variable</p>
<div class="sidebarblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">export WEBHOOKSITE=&lt;webhoot.site url that you copied in the previous step&gt;</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Run the following command to update the backend service&#8217;s environment variables.</p>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">oc set env deployments/order-placement --overwrite ORDER_PLACEMENT_API=$WEBHOOKSITE -n globex-user1</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>You will see the output <code>deployment.apps/order-placement updated</code></p>
</li>
<li>
<p>This is how the env variables of the <a href="https://console-openshift-console.%SUBDOMAIN%/k8s/ns/globex-user1/deployments/order-placement/environment" target="console">Order Placement service</a> will look like after update.</p>
<div class="imageblock">
<div class="content">
<img src="_images/order-placement-config-after.png" alt="order placement config after">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Any payload being POSTed to this service will now be sent to this webhook site for inspection.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Instead of a plain JSON order payload, you can consider the payload to be a <a href="https://cloudevents.io/" target="_blank" rel="noopener">CloudEvents</a>. CloudEvents can then hold versions in their headers which makes it easier to route to different downstream systems through (for e.g.) using Knative Eventing</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_as_an_api_provider"><a class="anchor" href="#_as_an_api_provider"></a><a class="link" href="#_as_an_api_provider">4.3. As an API Provider</a></h3>
<div class="paragraph">
<p><strong>Setup 3scale entities</strong></p>
</div>
<div class="paragraph">
<p>Just like the code, all the 3scale Custom Resources are also maintained in git and are managed through ArgoCD/GitOps. This helps to version the 3scale entities as well.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run this command from where you have cloned the ansible playbook in the first step.</p>
<div class="ulist">
<ul>
<li>
<p>This command will use the git branch <code>1.0.0</code> as the source of truth since we start with version <code>1.0.0</code></p>
</li>
<li>
<p>This command will create version 1.0.0 of 3scale Backend, Product, Application Plans, Developer Account and the Application for the account as well</p>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">ansible-playbook playbook.yml --skip-tags "main" --extra-vars "apim_gitops_repo_value=https://github.com/rh-soln-pattern-api-versioning/api-versioning-helm apim_gitops_repo_tag_value=1.0.0"</code></pre>
</div>
</div>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>The above command setup up an ArgoCD application which is responsible for the 3scale custom resources</p>
<details>
<summary class="title"><strong class="underline">Click to learn how to access ArgoCD</strong></summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p>From the OpenShift console, click on the Clutser Argo CD menu</p>
<div class="imageblock">
<div class="content">
<img src="_images/argo-cd-menu.png" alt="argo cd menu">
</div>
</div>
</li>
<li>
<p>You will next need to get the ArgoCD admin credentials.</p>
</li>
<li>
<p>Access this from <code>openshift-gitops-cluster</code> secret in the openshift-gitops namespace. Launch <a href="https://console-openshift-console.%SUBDOMAIN%/k8s/ns/openshift-gitops/secrets/openshift-gitops-cluster" target="console">openshift-gitops-cluster here</a></p>
</li>
<li>
<p>Copy the <strong>admin.password</strong> from the bottom of this page</p>
</li>
<li>
<p>Login to ArgoCD with <strong>username</strong>: <em>admin</em> and <strong>password</strong>: <em>from openshift-gitops-cluster secret</em></p>
</li>
<li>
<p>You will note that there are a number of Argo applications</p>
<div class="imageblock">
<div class="content">
<img src="_images/argo-apps.png" alt="argo apps">
</div>
</div>
</li>
<li>
<p>The <strong>apim-user1</strong> contains all of the 3scale custom resources. Go ahead and explore this - you will see Product, Backend, Developer Account amongst other things.</p>
</li>
</ul>
</div>
</div>
</details>
</li>
<li>
<p>Click on <a href="https://3scale-user1-admin.%SUBDOMAIN%" target="3scale">3scale</a> to view all the entities that have been created for you. Login using (user1/openshift)</p>
<div class="paragraph">
<p><span class="image"><img src="_images/apim-v100-overview.png" alt="apim v100 overview"></span></p>
</div>
</li>
<li>
<p>Note that the <strong>Globex Order Placement Product</strong> and <strong>Globex Order Placement Backend</strong> are now created.</p>
</li>
<li>
<p><strong>ActiveDoc</strong> can be viewed under <strong>Globex Order Placement Product &#8594; ActiveDocs</strong></p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>ActiveDoc is created with OpenApi Specs. For the purpose of this solution pattern we are using a prebuilt OpenAPI.</p>
</li>
<li>
<p>Apicurio API designer is a great tool to build API designs. You can then manage it with Apicurio Service Registry</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Click on <strong>Globex Order Placement Product</strong> navigate to <strong>Product&#8594; Integration &#8594; Methods and Metrics</strong> to view what&#8217;s been setup.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Methods and Metrics help map different backend services to different paths representing URL versions, and also help to track metrics based on hits for different backend service versions</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/methods-100.png" alt="methods 100">
</div>
</div>
</li>
<li>
<p>Now click on <strong>Mapping Rules</strong> link. The Mapping rules help to route a request to the right version of backend service (e.g. /v1/placeorder)</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">E.g. `api.globex.com/v1/OrderPlacement` will go to `v1` backend service</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/methods-v100-mapping-rules.png" alt="methods v100 mapping rules">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The Mapping Rule with the pattern <code>/{version}</code> also helps to track all the metrics to Globex Order Placement API in total.</p>
<div class="ulist">
<ul>
<li>
<p><code>Order Placement API</code> tracks all hits made to the API irrespective of which version</p>
</li>
</ul>
</div>
</li>
<li>
<p>The Mapping Rule with the pattern <code>/v1</code> also helps to track all the metrics to Globex Order Placement API in total.</p>
<div class="ulist">
<ul>
<li>
<p><code>Method version 1.0.0</code> tracks hits made to the 1.1.0 API version which accessed by path <strong>/v1</strong> only</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Before you can start accessing the Globex Order Placement API, you must promote the APIcast configuration as below.<br></p>
<details>
<summary class="title"><strong class="underline">Click to view what is APICast</strong></summary>
<div class="content">
<div class="paragraph">
<p>APIcast is an NGINX based API gateway used to integrate your internal and external API services with the Red Hat 3scale Platform. In this workshop we use the two built-in APICast (staging and production) that come by default with the 3scale installation. They come pre-configured and ready to use out-of-the-box.</p>
</div>
</div>
</details>
</li>
<li>
<p>From the left hand menu, navigate to <strong>Integration</strong> &#8594; <strong>Backend</strong> to view the <strong>Globex Order Placement Backend</strong>.<br>
<strong>Note</strong> The <em>Public path</em> to access this version is <strong>/v1</strong></p>
<div class="imageblock">
<div class="content">
<img src="_images/apim-backend100.png" alt="apim backend100">
</div>
</div>
</li>
<li>
<p>From the <a href="https://3scale-user1-admin.%SUBDOMAIN%" target="3scale">3scale homepage</a>, under the Products section, click on <strong>Globex Order Placement</strong> to view the Product&#8217;s overview page. From the left hand menu, navigate to <strong>Integration</strong> &#8594; <strong>Configuration</strong></p>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Under <strong>APIcast Configuration</strong>, click <strong>Promote to v.x Staging APICast</strong> to promote the APIcast configurations. Similarly click <strong>Promote to v.x Production APICast</strong></p>
</div>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/apim-promote-prod.png" alt="apim promote prod">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Note that <strong>Globex Order Placement Backend</strong> shows that the backend is mapped as "v1". The API will then be accessed via <strong>v1</strong> path. This helps in versioning this OrderPlacement API as <strong>1.0.0</strong></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_as_an_api_consumer"><a class="anchor" href="#_as_an_api_consumer"></a><a class="link" href="#_as_an_api_consumer">4.4. As an API Consumer</a></h3>
<div class="paragraph">
<p><strong>Globex UI patched with API Credentials and APICast URL</strong></p>
</div>
<div class="paragraph">
<p>Next step, patch the <code>globex-ui</code> deployment with the API credentials and the APIcast URL. Typically developers get APICredentials from the Developer Portal.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In 3scale, navigate to <strong>Audience (from top nav) &#8594; Developer Portal &#8594; Visit Portal</strong></p>
<div class="imageblock">
<div class="content">
<img src="_images/access-devportal.png" alt="access devportal">
</div>
</div>
</li>
<li>
<p>Sign in using (<strong>dev.globex/openshift</strong>)</p>
<div class="imageblock">
<div class="content">
<img src="_images/dev-portal-login.png" alt="dev portal login">
</div>
</div>
</li>
<li>
<p>Click on <strong>API credentials</strong> link on top nav, and you will see <strong>Globex Basic Application</strong></p>
<div class="ulist">
<ul>
<li>
<p>Copy the alphanumeric value found as <strong>User Key</strong> and create environment variable <code>API_USER_KEY_VALUE</code></p>
<div class="imageblock">
<div class="content">
<img src="_images/application-credentials-1.0.png" alt="application credentials 1.0">
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">export API_USER_KEY_VALUE=&lt;replace with user key&gt;</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Run the following command to update the backend service&#8217;s env variables.</p>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">oc set env deployments/globex-ui --overwrite API_USER_KEY_VALUE=$API_USER_KEY_VALUE \
API_TRACK_PLACEORDER=https://globex-order-placement-product-3scale-user1-apicast-staging.%SUBDOMAIN%/v1/placeorder -n globex-user1</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>You should see an output message <code>deployment.apps/globex-ui updated</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_testing_this_out"><a class="anchor" href="#_testing_this_out"></a><a class="link" href="#_testing_this_out">4.5. Testing this out</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Launch the <a href="https://globex-ui-globex-user1.%SUBDOMAIN%/products" target="_blank" rel="noopener">retail website</a></p>
</li>
<li>
<p>Login using any valid email address and any 6-digit password - since this is just a simulation.</p>
</li>
<li>
<p>Navigate to the <strong>Cool Stuff Store</strong> from the top menu. Add a few things to the cart.</p>
</li>
<li>
<p>Click on <strong>Cart</strong> from the top menu and <strong>Proceed to Checkout</strong>.</p>
</li>
<li>
<p>Click on the <strong>Autofill form</strong> button to make it easy to fill this form.</p>
<div class="imageblock">
<div class="content">
<img src="_images/globex-ui-v-100.png" alt="globex ui v 100">
</div>
</div>
</li>
<li>
<p>Click on <strong>Submit Order</strong></p>
</li>
<li>
<p>You must see a success message</p>
<div class="imageblock">
<div class="content">
<img src="_images/globex-ui-order-submit.png" alt="globex ui order submit">
</div>
</div>
</li>
<li>
<p>You can view the payload on the webhook.site that you setup</p>
<div class="imageblock">
<div class="content">
<img src="_images/webhook-v100.png" alt="webhook v100">
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_view_traffic_analytics"><a class="anchor" href="#_view_traffic_analytics"></a><a class="link" href="#_view_traffic_analytics">4.6. View Traffic Analytics</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Try placing a few orders to generate traffic.</p>
</li>
<li>
<p>Navigate to <a href="https://3scale-user1-admin.%SUBDOMAIN%" target="3scale">3scale Dashboard</a>, and click on <strong>globex-order-placement</strong> to view the Product Details</p>
</li>
<li>
<p>Click on the <strong>Analytics &#8594; Traffic</strong> link on the left hand side menu. You will see the <strong>Hits</strong> details.</p>
</li>
<li>
<p>This section provides insights in terms of the number of hits for the product and other traffic analysis details as well.</p>
<div class="paragraph">
<p><span class="image"><img src="_images/apim-traffic.png" alt="apim traffic"></span></p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_3_enable_version_1_1_0"><a class="anchor" href="#_step_3_enable_version_1_1_0"></a><a class="link" href="#_step_3_enable_version_1_1_0">5. Step 3: Enable Version 1.1.0</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Globex now wants to capture a new field called <strong>Delivery Instructions</strong> to make it easier to make prompt deliveries This is considered as a non-breaking change because this is an optional field. To handle the new field, let&#8217;s introduce version 1.1.0 of OrderPlacement API.</p>
</div>
<div class="paragraph">
<p>This change has varying degrees of  impact across the different stakeholders (provider, developer &amp; consumer)</p>
</div>
<details>
<summary class="title"><strong class="underline">Click to view a summary</strong></summary>
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>As an <strong>API provider</strong></p>
<div class="ulist">
<ul>
<li>
<p>Use APICurio studio to make changes to OpenAPI Specification to include Optional field <strong>Delivery Instructions</strong> and change version from 1.0.0 to 1.1.0</p>
</li>
<li>
<p>Publish this on Apicurio Service Registry</p>
</li>
<li>
<p>Update 3scale for new Backend (version 1.1.0), update Product to point to the Backend version 1.1.0, update ActivdDoc</p>
</li>
<li>
<p>Point to new Backend service which adheres to the new API specification</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As mentioned earlier the APICurio studio and Apicurio Service Registry changes are not included to keep this solution pattern accessible and not overtly too lengthy.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>As a <strong>Backend service developer</strong></p>
<div class="ulist">
<ul>
<li>
<p>Create a new branch with name <strong>v1.1.0</strong> and change the Order Placement service to allow for <strong>Delivery Instructions</strong></p>
</li>
<li>
<p>Update any POJOs or mapping - ideally it is better to handle this as a JSON payload rather than mapping to a POJO so as to allow for minimal impact</p>
</li>
<li>
<p>Update validations against new OpenAPI spec. In our case we use JSON Schema based validation.</p>
</li>
</ul>
</div>
</li>
<li>
<p>As an <strong>API consumer</strong></p>
<div class="ulist">
<ul>
<li>
<p>May choose to consume the new API at their own pace.</p>
</li>
<li>
<p>Changes includ update to the UI to allow for the new field <strong>Delivery Instructions</strong>.</p>
</li>
<li>
<p>Change any validations if necessary. Ensure adherence to new OpenAPI specification</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</details>
<div class="sect2">
<h3 id="_as_a_backend_developer_2"><a class="anchor" href="#_as_a_backend_developer_2"></a><a class="link" href="#_as_a_backend_developer_2">5.1. As a backend developer</a></h3>
<div class="paragraph">
<p><strong>Deploy new version 1.1.0 of the backend service</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The backend service deployment for version 1.1.0 has been already deployed as part of the setup to keep things simpler for the demo, but is set as replica 0 (i.e, it is at zero pods)</p>
</li>
<li>
<p>The OpenAPI specification has been updated with optional <strong>Delivery Instructions</strong>. You can view the version <a href="https://raw.githubusercontent.com/rh-soln-pattern-api-versioning/api-spec/main/v1.1/OrderPlacementAPI-V1.1.yaml" target="_blank" rel="noopener">1.1.0 here</a></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">openapi: 3.0.2
info:
  title: OrderPlacementAPI V1.1
  version: 1.1.0
  description: 'API Call to place an order with product, address and user details'
......
    delivery_instructions:
     description: Send optional delivery instructions
......</code></pre>
</div>
</div>
</li>
<li>
<p>The OpenAPI specification for this version 1.1.0 has been converted ionto JSON Schema and is part of this backend service. Click here to view the <a href="https://raw.githubusercontent.com/rh-soln-pattern-api-versioning/order-placement-service/1.1.0/src/main/java/org/globex/retail/json-schema/order-placement-payload.json" target="_blank" rel="noopener">version 1.1.0 JSON Schema</a>. Note the introduction of <strong>delivery_instructions</strong> field which is optional</p>
<div class="imageblock">
<div class="content">
<img src="_images/json-schema-v110.png" alt="json schema v110" width="50%">
</div>
</div>
</li>
<li>
<p>Patch the <code>order-placement-v1-1-0</code> deployment with the webhook.site URL that you have setup earlier.</p>
<div class="ulist">
<ul>
<li>
<p>From your command prompt <code>echo $WEBHOOKSITE</code> to make sure you have the env variable accessible</p>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">echo $WEBHOOKSITE</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Run the following command to update the backend service&#8217;s environment variables, and scale the replica to <code>1</code></p>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">oc set env deployments/order-placement-v1-1-0 --overwrite ORDER_PLACEMENT_API=$WEBHOOKSITE -n globex-user1
oc scale deployment order-placement-v1-1-0 --replicas=1 -n globex-user1</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Output would be like this</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">deployment.apps/order-placement-v1-1-0 updated
deployment.apps/order-placement-v1-1-0 scaled</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_as_an_api_provider_2"><a class="anchor" href="#_as_an_api_provider_2"></a><a class="link" href="#_as_an_api_provider_2">5.2. As an API Provider</a></h3>
<div class="paragraph">
<p><strong>Configure 3scale entities for version 1.1.0</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run this command from the command prompt from where you have cloned the ansible playbook.</p>
<div class="ulist">
<ul>
<li>
<p>This command will use the git branch <code>1.1.0</code> as the source of truth since we are now rolling out version <code>1.1.0</code></p>
</li>
<li>
<p>This command will create version 1.1.0 of 3scale Backend, Product, Application Plans, Developer Account and the Application for the account as well</p>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">ansible-playbook playbook.yml --skip-tags "main" --extra-vars "apim_gitops_repo_value=https://github.com/rh-soln-pattern-api-versioning/api-versioning-helm apim_gitops_repo_tag_value=1.1.0"</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>The output will be like this</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">PLAY RECAP ******************************************************************************************************************
localhost         : ok=12  changed=1  unreachable=0  failed=0  skipped=3  rescued=0  ignored=0</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>You can access ArgoCD as described earlier to view the new entities for v1.1.0 being deployment (including new Backend, updates to the Product)</p>
</li>
<li>
<p>From 3scale promote APICast configuration from <strong>Globex Order Placement Product &#8594; Integration &#8594; Configuration &#8594; *Promote to v.x Staging APICast</strong> and <strong>Promote to v.x Production APICast</strong></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_as_an_api_consumer_2"><a class="anchor" href="#_as_an_api_consumer_2"></a><a class="link" href="#_as_an_api_consumer_2">5.3. As an API Consumer</a></h3>
<div class="paragraph">
<p><strong>Update UI to updated version 1.1.0</strong></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is a backward compatible change. Therefore, the existing <strong>globex-ui 1.0.0</strong> deployment will work as it is without any changes with the new <strong>Backend 1.1.0</strong> version. You can test this out just to be sure :)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the UI developers are ready, they can make the following changes to start consuming the new changes, and send the new Delivery Instructions as part of the order payload.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run this command to update the image of globex-ui deployment to the 1.1.0 version</p>
</li>
</ol>
</div>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">oc set image deployment/globex-ui globex-ui=quay.io/rh_soln_pattern_api_versioning/globex-ui:1.1.0 -n globex-user1</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_this_out_2"><a class="anchor" href="#_testing_this_out_2"></a><a class="link" href="#_testing_this_out_2">5.4. Testing this out</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Launch the <a href="https://globex-ui-globex-user1.%SUBDOMAIN%/products" target="_blank" rel="noopener">retail website</a> preferably in incognito - or perform a hard refresh of the browser to nullify caching.</p>
</li>
<li>
<p>Login using any valid email address and any 6-digit password.</p>
</li>
<li>
<p>Navigate to the <strong>Cool Stuff Store</strong> from the top menu. Add a few things to the card and proceed to checkout</p>
</li>
<li>
<p>Notice that there is a new field called <strong>Delivery Instructions</strong>. Provide some content for this new field, and click on <strong>Submit Order</strong></p>
<div class="imageblock">
<div class="content">
<img src="_images/delivery-instructions.png" alt="delivery instructions">
</div>
</div>
</li>
<li>
<p>You should see a confirmation message that the order has been placed.</p>
</li>
<li>
<p>Navigate to the webhook.site you have setup to check that the <strong>delivery_instructions</strong> is being passed on correctly</p>
<div class="imageblock">
<div class="content">
<img src="_images/delivery-instructions-webhook.png" alt="delivery instructions webhook">
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_4_enable_version_2_0_0"><a class="anchor" href="#_step_4_enable_version_2_0_0"></a><a class="link" href="#_step_4_enable_version_2_0_0">6. Step 4: Enable Version 2.0.0</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Further down the line, Globex would like to merge <strong>First name and Last name</strong> into a single field to better represent different cultures and conventions.</p>
</div>
<div class="paragraph">
<p>This is considered as a breaking change since there is no backward compatibility leading to a major version change to OpenAPI spec <strong>version 2.0.0</strong></p>
</div>
<div class="paragraph">
<p>The version 2.0.0 of this <strong>Globex Order Placement API</strong> has already been created for you. This can be viewed in github <a href="https://raw.githubusercontent.com/rh-soln-pattern-api-versioning/api-spec/main/v2.0/OrderPlacementAPI-V2.0.yaml" target="_blank" rel="noopener">here</a>.</p>
</div>
<div class="paragraph">
<p>The same set of impacts identified across the different stakeholders while introducing version 1.1.0 also applies for a Major version change. The main impact is that, this version is NOT backward compatible.</p>
</div>
<div class="sect2">
<h3 id="_as_a_backend_developer_3"><a class="anchor" href="#_as_a_backend_developer_3"></a><a class="link" href="#_as_a_backend_developer_3">6.1. As a backend developer</a></h3>
<div class="paragraph">
<p><strong>New version 2.0.0 of the backend service</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The backend service deployment for version 2.0.0 is in place to keep this pattern simple, but is set as replica 0 (i.e, it is at zero pods)</p>
<div class="ulist">
<ul>
<li>
<p>The OpenAPI specification for this version 2.0.0 has been converted into JSON Schema and is part of this backend service. Click here to view the <a href="https://raw.githubusercontent.com/rh-soln-pattern-api-versioning/order-placement-service/2.0.0/src/main/java/org/globex/retail/json-schema/order-placement-payload.json" target="_blank" rel="noopener">version 2.0.0 JSON Schema</a>. Note the introduction of <strong>name</strong> field which is not optional, and has replaced first name and last name  fields.</p>
<div class="imageblock">
<div class="content">
<img src="_images/json-schema-v200.png" alt="json schema v200" width="50%">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>You will need to patch this deployment as well with the <strong>webhook.site URL</strong> that you have setup earlier.</p>
<div class="ulist">
<ul>
<li>
<p>From your command prompt <code>echo $WEBHOOKSITE</code> to make sure you have the env variable accessible</p>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">echo $WEBHOOKSITE</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Run the following command to update the <code>order-placement-v2-0</code> service&#8217;s environment variables, and scale the replica to <code>1</code></p>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">oc set env deployments/order-placement-v2-0 --overwrite ORDER_PLACEMENT_API=$WEBHOOKSITE -n globex-user1
oc scale deployments/order-placement-v2-0 --replicas=1 -n globex-user1</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Output would be like this</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">deployment.apps/order-placement-v2-0 updated
deployment.apps/order-placement-v2-0 scaled</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_as_an_api_provider_3"><a class="anchor" href="#_as_an_api_provider_3"></a><a class="link" href="#_as_an_api_provider_3">6.2. As an API Provider</a></h3>
<div class="paragraph">
<p><strong>Setup 3scale entities for version 2.0.0</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run this command from the command prompt from where you have cloned the ansible playbook.</p>
<div class="ulist">
<ul>
<li>
<p>This command will use the git branch <code>2.0.0</code> as the source of truth since we are now rolling out version <code>2.0.0</code></p>
</li>
<li>
<p>This command will create version 2.0.0 of 3scale Backend, Product, Application Plans, Developer Account and the Application for the account as well</p>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">ansible-playbook playbook.yml --skip-tags "main" --extra-vars "apim_gitops_repo_value=https://github.com/rh-soln-pattern-api-versioning/api-versioning-helm apim_gitops_repo_tag_value=2.0.0"</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>The output will be like this</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">PLAY RECAP ******************************************************************************************************************
localhost         : ok=12  changed=1  unreachable=0  failed=0  skipped=3  rescued=0  ignored=0</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>From 3scale promote APICast configuration from <strong>Globex Order Placement Product &#8594; Integration &#8594; Configuration &#8594; *Promote to v.x Staging APICast</strong> and <strong>Promote to v.x Production APICast</strong></p>
</li>
<li>
<p>Note from <strong>Globex Order Placement Product&#8594; Integration &#8594; Backend</strong> that new Backend has been added mapped to <code>/v2</code> path.</p>
<div class="imageblock">
<div class="content">
<img src="_images/backend-v200.png" alt="backend v200">
</div>
</div>
</li>
<li>
<p>Navigate to <strong>Globex Order Placement Product&#8594; Integration &#8594; Methods and Metrics</strong> and note that a new method for <code>v2</code> has been added</p>
<div class="imageblock">
<div class="content">
<img src="_images/methods-v200.png" alt="methods v200">
</div>
</div>
</li>
<li>
<p>Navigate to the <strong>Mapping Rules</strong> menu and note that a new rule for <code>/v2</code> has been added which will direct all api calls with <code>/v2</code> to the new version 2.0.0 backend</p>
<div class="imageblock">
<div class="content">
<img src="_images/mapping-rules-200.png" alt="mapping rules 200">
</div>
</div>
</li>
<li>
<p>Promote APICast configuration</p>
</li>
</ol>
</div>
<div class="sidebarblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Promote APICast configuration from Integration &#8594; Configuration &#8594; <strong>Promote to v.x Staging APICast</strong> and <strong>Promote to v.x Production APICast</strong></p>
</li>
<li>
<p>You now have 2 Backends configured which would both work correctly when invoked via /v1/ and /v2/ paths.</p>
<div class="imageblock">
<div class="content">
<img src="_images/config-200.png" alt="config 200">
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_as_an_api_consumer_3"><a class="anchor" href="#_as_an_api_consumer_3"></a><a class="link" href="#_as_an_api_consumer_3">6.3. As an API Consumer</a></h3>
<div class="paragraph">
<p><strong>Update UI to version 2.0.0</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run this command to update the image of globex-ui deployment to the 2.0.0 version and update the env variables</p>
<div class="sidebarblock">
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">oc set image deployment/globex-ui globex-ui=quay.io/rh_soln_pattern_api_versioning/globex-ui:2.0.0 -n globex-user1
oc set env deployments/globex-ui --overwrite API_USER_KEY_VALUE=$API_USER_KEY_VALUE \
API_TRACK_PLACEORDER=https://globex-order-placement-product-3scale-user1-apicast-staging.%SUBDOMAIN%/v2/placeorder -n globex-user1</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>You will see the output <code>deployment.apps/globex-ui image updated</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_testing_this_out_3"><a class="anchor" href="#_testing_this_out_3"></a><a class="link" href="#_testing_this_out_3">6.4. Testing this out</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Launch the <a href="https://globex-ui-globex-user1.%SUBDOMAIN%/products" target="_blank" rel="noopener">retail website</a> preferably in incognito - or perform a hard refresh of the browser to nullify caching.</p>
</li>
<li>
<p>Login using any valid email address and any 6-digit password.</p>
</li>
<li>
<p>Navigate to the <strong>Cool Stuff Store</strong> from the top menu. Add a few things to the card and proceed to checkout</p>
</li>
<li>
<p>Notice that there is a new field called <strong>Delivery Instructions</strong>. Provide some content for this new field, and click on <strong>Submit Order</strong></p>
<div class="imageblock">
<div class="content">
<img src="_images/globex-ui-combined-name.png" alt="globex ui combined name">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>You should see a confirmation message that the order has been placed.</p>
</li>
<li>
<p>Navigate to the webhook.site you have setup to check that the <strong>delivery_instructions</strong> is being passed on correctly</p>
<div class="imageblock">
<div class="content">
<img src="_images/combined-name-webhook.png" alt="combined name webhook">
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_view_traffic_analytics_2"><a class="anchor" href="#_view_traffic_analytics_2"></a><a class="link" href="#_view_traffic_analytics_2">6.5. View Traffic Analytics</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Try placing a few orders to generate traffic. You can also place dummy orders as discussed earlier.</p>
</li>
<li>
<p>Navigate to <a href="https://3scale-user1-admin.%SUBDOMAIN%" target="3scale">3scale Dashboard</a>, and click on <strong>Globex Order Placement Product</strong> to view the Product Details</p>
</li>
<li>
<p>Click on the <strong>Analytics &#8594; Traffic</strong> link on the left hand side menu. You will see the <strong>Hits</strong> details split between the versions v1 and v2.</p>
<div class="paragraph">
<p><span class="image"><img src="_images/apim-traffic-200.png" alt="apim traffic 200"></span></p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_5_manage_and_analyse_analytics_consumer_notification"><a class="anchor" href="#_step_5_manage_and_analyse_analytics_consumer_notification"></a><a class="link" href="#_step_5_manage_and_analyse_analytics_consumer_notification">7. Step 5: Manage and Analyse: Analytics, consumer notification</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Especially with the introduction of a breaking change, you will like to sunset your older version of the API at the earliest. You will need to start by notifying the consumers.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to <a href="https://3scale-user1-admin.apps.cluster-w6wln.dynamic.redhatworkshops.io/buyers/accounts" target="_blank" rel="noopener">Audience (from top menu) &#8594; Accounts &#8594; Listing</a>.</p>
</li>
<li>
<p>You will see the number of applications the Globex user has signed for. (in this case it is 2). You can search for the Accounts which have signed up for the Order Placement API by using the search term <strong>Globex Basic</strong></p>
<div class="imageblock">
<div class="content">
<img src="_images/audience-acc-listing.png" alt="audience acc listing">
</div>
</div>
</li>
<li>
<p>You can also drill down to an account by clicking on the hyperlink [2]</p>
</li>
<li>
<p>From the <strong>Applications for Globex Page</strong> click the "x Applications" link on top</p>
<div class="imageblock">
<div class="content">
<img src="_images/globex-acc-listing.png" alt="globex acc listing">
</div>
</div>
</li>
<li>
<p>You can now choose the relevant accounts to view the <strong>Bulk operations</strong> available.</p>
<div class="imageblock">
<div class="content">
<img src="_images/bulk-ops.png" alt="bulk ops">
</div>
</div>
</li>
<li>
<p>Click on <strong>Send email</strong> to send a notification saying something like this.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Subject: Basic Plan of Globex Order Placement version 1.1.0 deprecation
Body of Email:
Hello
Please note that Globex Order Placement version 1.1.0 is being deprecated and will not be available for new signups. The version 1.1.0 will be removed by &lt;date&gt;.
Please refer to the Developer Portal for details of version 2.0.0</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_make_the_1_1_0_version_unavailable_for_signups"><a class="anchor" href="#_make_the_1_1_0_version_unavailable_for_signups"></a><a class="link" href="#_make_the_1_1_0_version_unavailable_for_signups">7.1. Make the 1.1.0 version unavailable for signups</a></h3>
<div class="paragraph">
<p>Once you are ready to sunset the older version here is what you can do:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Navigate to <strong>Products &#8594; Globex Order Placement &#8594; Applications &#8594; Application Plans</strong></p>
</li>
<li>
<p>Click on the green checkboxes for Enabled and Visible columns for the <code>Method version 1.0.0</code> to make it red as shown below.</p>
<div class="imageblock">
<div class="content">
<img src="_images/method-v100-off.png" alt="method v100 off">
</div>
</div>
</li>
<li>
<p>All calls to /v1/ will now fail authentication.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_alternatives_to_introducing_new_versions"><a class="anchor" href="#_alternatives_to_introducing_new_versions"></a><a class="link" href="#_alternatives_to_introducing_new_versions">8. Alternatives to introducing new versions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this pattern we continued to use the same Application Plan for all revisions. In the real world, there are options that can be considered based on the context of how the teams function, and what is relevant for business.</p>
</div>
<div class="sect2">
<h3 id="_new_3scale_product"><a class="anchor" href="#_new_3scale_product"></a><a class="link" href="#_new_3scale_product">8.1. New 3scale Product</a></h3>
<div class="paragraph">
<p>For breaking changes, you may consider creating a new 3scale Product for version 2.0.0. Once you are ready to sunset the version 1.x.x, just delete the product.</p>
</div>
</div>
<div class="sect2">
<h3 id="_new_application_plan"><a class="anchor" href="#_new_application_plan"></a><a class="link" href="#_new_application_plan">8.2. New application plan</a></h3>
<div class="paragraph">
<p>You may also consider creating a new application plan for the new version. Here is how this would pan out</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Existing application plan, turn off access to version 2.0.0 Backend</p>
<div class="imageblock">
<div class="content">
<img src="_images/edit-app-plan-100.png" alt="edit app plan 100">
</div>
</div>
</li>
<li>
<p>Create a new application plan for version 2.0.0</p>
<div class="imageblock">
<div class="content">
<img src="_images/app-plan-200.png" alt="app plan 200">
</div>
</div>
</li>
<li>
<p>Unpublish the older application plan by changing the <strong>State</strong> to hidden.</p>
<div class="imageblock">
<div class="content">
<img src="_images/hide-app-plan-100.png" alt="hide app plan 100">
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_advantages_of_this_option"><a class="anchor" href="#_advantages_of_this_option"></a><a class="link" href="#_advantages_of_this_option">8.3. Advantages of this option:</a></h3>
<div class="ulist">
<ul>
<li>
<p>This means that all new users will only be able to sign up to the newer plan; when version 1.x.x is being sunset, you can just delete all those applications and the plan itself</p>
</li>
<li>
<p>Another advantage of creating a new application plan is that when you unpublish it on the developer portal, you won&#8217;t have any net new signups for the old version. But you can also provide an ELS option for some existing customers(if needed) without the risk of new people signing up to the API.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion"><a class="anchor" href="#_conclusion"></a><a class="link" href="#_conclusion">9. Conclusion</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Congratulations on completing this Solution Pattern. As a takeaway</p>
</div>
<div class="ulist">
<ul>
<li>
<p>APIs are very useful as building blocks for internal and external system integrations</p>
</li>
<li>
<p>Don&#8217;t change frequently - but have a public strategy in place to have predictable releases and consumer notification</p>
</li>
<li>
<p>Consider including Release Notes in your developer portal with access to OpenAPI Specs, trials and code samples</p>
</li>
<li>
<p>GitOps and ArgoCD are you friends to make this manageable and trackable</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To sum up, build <strong>Intentional APIs</strong>. Be deliverate while creating APIs for internal or external stake holders. Being intentional across the API lifecycle from designing, developing, versioning and managing it, makes for easier adoption and higher adoption.</p>
</div>
<div class="paragraph">
<p><strong>Explore more Solution Patterns <a href="https://redhat-solution-patterns.github.io/solution-patterns/patterns.html" target="_blank" rel="noopener">here</a></strong></p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-architecture.html" class="query-params-link">2. Architecture</a></span>
  <span class="next"><a href="04-developer-resources.html" class="query-params-link">4. Developer Resources</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer" style="justify-content: center;">
  <div>
    <img src="./_images/red_hat_logo.png" height="40px" alt="Cloud Native Architecture Solution Patterns" href="https://redhat.com">
  </div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
